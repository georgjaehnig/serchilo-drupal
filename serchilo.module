<?php
/**
 * @file
 * Code for the Serchilo feature.
 */

include_once 'serchilo.features.inc';

/**
 * Implements hook_revisionapi().
 */
function serchilo_revisionapi($op, $node) {

  if ($op == 'post publish') {
    if ($node->type == 'shortcut') {
      $command_id = drupal_array_get_nested_value($node->field_command_id, array(LANGUAGE_NONE, 0, 'value'));
      if (empty($command_id)) {
        $command_id = _serchilo_insert_shortcut_row($node);
        drupal_array_set_nested_value($node->field_command_id, array(LANGUAGE_NONE, 0, 'value'), $command_id);
        // need to save the node to remember the command_id
        node_save($node);
      }
      else {
        _serchilo_update_shortcut_row($node);
      }
    }
  }
}

/**
 * Implements hook_node_presave().
 */
function serchilo_node_presave($node) {

  if ($node->type == 'shortcut') {
    $no_sensible_edit = (
      (
        // no change in keyword
        drupal_array_get_nested_value($node->original->field_keyword, array(LANGUAGE_NONE, 0, 'value')) 
        == drupal_array_get_nested_value($node->field_keyword, array(LANGUAGE_NONE, 0, 'value'))
      ) 
      &&
      (
        // no change in url
        drupal_array_get_nested_value($node->original->field_url, array(LANGUAGE_NONE, 0, 'value')) 
        == drupal_array_get_nested_value($node->field_url, array(LANGUAGE_NONE, 0, 'value'))
      ) 
      &&
      (
        // no change in namespace
        drupal_array_get_nested_value($node->original->field_namespace, array(LANGUAGE_NONE, 0, 'tid')) 
        == drupal_array_get_nested_value($node->field_namespace, array(LANGUAGE_NONE, 0, 'tid'))
      ) 
    );
    if ($no_sensible_edit) {
      $node->revision_operation = REVISIONING_NEW_REVISION_NO_MODERATION;
    }
    $no_moderation = (
      (property_exists($node, 'revision_operation')) && 
      ($node->revision_operation == REVISIONING_NEW_REVISION_NO_MODERATION)
    );
    if ($no_moderation) {
      $command_id = drupal_array_get_nested_value($node->field_command_id, array(LANGUAGE_NONE, 0, 'value'));
      if (empty($command_id)) {
        $command_id = _serchilo_insert_shortcut_row($node);
        drupal_array_set_nested_value($node->field_command_id, array(LANGUAGE_NONE, 0, 'value'), $command_id);
      }
      else {
        _serchilo_update_shortcut_row($node);
      }
    }
  }
}

/**
 * Implements hook_node_delete().
 */
function serchilo_node_delete($node) {
  if ($node->type == 'shortcut') {
    $command_id = drupal_array_get_nested_value($node->field_command_id, array(LANGUAGE_NONE, 0, 'value'));
    if (!empty($command_id)) {
      _serchilo_delete_shortcut_row($node);
    }
  }
}

/**
 * Retrieve database fields from shortcut node.
 *
 * @param $node
 *   Node of type shortcut
 * @return
 *   array to pass to fields()
 */
function _serchilo_shortcut_to_db_fields($node) {

  // TODO:
  // remove when implemented calculation
  drupal_array_set_nested_value($node->field_argument_names, array(LANGUAGE_NONE, 0, 'value'), '');
  $fields = array(
    'title' => $node->title,
    'keyword' =>        drupal_array_get_nested_value($node->field_keyword,        array(LANGUAGE_NONE, 0, 'value')),
    'argument_names' => drupal_array_get_nested_value($node->field_argument_names, array(LANGUAGE_NONE, 0, 'value')),
    'argument_count' => drupal_array_get_nested_value($node->field_argument_count, array(LANGUAGE_NONE, 0, 'value')),
    'url' =>            drupal_array_get_nested_value($node->field_url,            array(LANGUAGE_NONE, 0, 'value')),
    'input_encoding' => drupal_array_get_nested_value($node->field_input_encoding, array(LANGUAGE_NONE, 0, 'value')),
    'weight' =>         drupal_array_get_nested_value($node->field_weight,         array(LANGUAGE_NONE, 0, 'value')),
    'invisible' =>      drupal_array_get_nested_value($node->field_invisible,      array(LANGUAGE_NONE, 0, 'value')),
    'set_referrer' =>   drupal_array_get_nested_value($node->field_set_referrer,   array(LANGUAGE_NONE, 0, 'value')),
    'namespace_id' =>   drupal_array_get_nested_value($node->field_namespace,      array(LANGUAGE_NONE, 0, 'tid'  )),
    'namespace_name' => drupal_array_get_nested_value($node->field_namespace,      array(LANGUAGE_NONE, 0, 'name' )),
  );

  return $fields;
}

function _serchilo_insert_shortcut_row($node) {
  $fields = _serchilo_shortcut_to_db_fields($node);
  $command_id = db_insert('serchilo_shortcut') 
    ->fields($fields)
    ->execute();
  // TODO
  // raise error when $command_id < 1
  dpm($command_id);
  return $command_id;
}

function _serchilo_update_shortcut_row($node) {
  $fields = _serchilo_shortcut_to_db_fields($node);
  $num_updated = db_update('serchilo_shortcut') 
    ->fields($fields)
    ->condition('id', $node->field_command_id[LANGUAGE_NONE][0]['value'] )
    ->execute();
  // TODO
  // raise error when $num_updated != 1
  dpm($num_updated);
}

function _serchilo_delete_shortcut_row($node) {
  $num_deleted = db_delete('serchilo_shortcut') 
    ->condition('id', $node->field_command_id[LANGUAGE_NONE][0]['value'] )
    ->execute();
  // TODO
  // raise error when $num_deleted != 1
  dpm($num_deleted);
}
